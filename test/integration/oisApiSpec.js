"use strict";

const {assert} = require('chai');
const {go} = require('ts-csp');

const testdb = require('../helpers/testdb2');
const oisApiModels = require('../../apiSpecification/ois/oisApiModels');
const registry = require('../../apiSpecification/registry');
const helpers = require('./helpers');
require('../../apiSpecification/allSpecs');

const expectedResults = {
  grund: {
    "2aee4375-4a3a-4e1d-91b4-1ba061b1fc97": {
      mini: {
        "ois_id": 49881,
        "ois_ts": "2010-12-17 13:10:48.303",
        "Grund_id": "2aee4375-4a3a-4e1d-91b4-1ba061b1fc97",
        "Kommune_id": "07c7b9a2-7320-436a-bf28-33883768e7e4",
        "ESREjdNr": "002632",
        "ObjStatus": 1,
        "NyByg": 0,
        "CRUD_ID": "327982550016005",
        "Cs_Crud_id": "0",
        "Byggesag_id": null,
        "GrundStam_id": null,
        "MatrSFE_id": "2695110",
        "AdgAdr_id": "0a3f5088-0121-32b8-e044-0003ba298018",
        "GRU_Afloeb_Kode": "10",
        "GRU_Afloeb_Tillad": null,
        "GRU_VandForsy_Kode": 2,
        "GRU_SagType": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2000-02-05T05:57:34.000",
        "AENDR_TS": "2008-12-08T11:16:19.000",
        "Aendr_Funk": "KONVERTERING2009",
        "Ophoert_ts": null,
        "Gyldighedsdato": null,
        "GruMdlSplvnd": null,
        "GruPbFrbRens": null,
        "GruPbFrbRensDato": null,
        "GruTilUdtr": null,
        "GruTilUdtrDato": null,
        "GruTilAltAfld": null,
        "GruTilAltAfldDato": null
      },
      nestet: {
        "ois_id": 49881,
        "ois_ts": "2010-12-17 13:10:48.303",
        "Grund_id": "2aee4375-4a3a-4e1d-91b4-1ba061b1fc97",
        "Kommune_id": "07c7b9a2-7320-436a-bf28-33883768e7e4",
        "ESREjdNr": "002632",
        "ObjStatus": 1,
        "NyByg": 0,
        "CRUD_ID": "327982550016005",
        "Cs_Crud_id": "0",
        "Byggesag_id": null,
        "GrundStam_id": null,
        "MatrSFE_id": "2695110",
        "AdgAdr_id": "0a3f5088-0121-32b8-e044-0003ba298018",
        "GRU_Afloeb_Kode": "10",
        "GRU_Afloeb_Tillad": null,
        "GRU_VandForsy_Kode": 2,
        "GRU_SagType": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2000-02-05T05:57:34.000",
        "AENDR_TS": "2008-12-08T11:16:19.000",
        "Aendr_Funk": "KONVERTERING2009",
        "Ophoert_ts": null,
        "Gyldighedsdato": null,
        "GruMdlSplvnd": null,
        "GruPbFrbRens": null,
        "GruPbFrbRensDato": null,
        "GruTilUdtr": null,
        "GruTilUdtrDato": null,
        "GruTilAltAfld": null,
        "GruTilAltAfldDato": null,
        "href": "http://dawa/ois/grunde/2aee4375-4a3a-4e1d-91b4-1ba061b1fc97"
      },
      flad: {
        "ois_id": 49881,
        "ois_ts": "2010-12-17 13:10:48.303",
        "Grund_id": "2aee4375-4a3a-4e1d-91b4-1ba061b1fc97",
        "Kommune_id": "07c7b9a2-7320-436a-bf28-33883768e7e4",
        "ESREjdNr": "002632",
        "ObjStatus": 1,
        "NyByg": 0,
        "CRUD_ID": "327982550016005",
        "Cs_Crud_id": "0",
        "Byggesag_id": null,
        "GrundStam_id": null,
        "MatrSFE_id": "2695110",
        "AdgAdr_id": "0a3f5088-0121-32b8-e044-0003ba298018",
        "GRU_Afloeb_Kode": "10",
        "GRU_Afloeb_Tillad": null,
        "GRU_VandForsy_Kode": 2,
        "GRU_SagType": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2000-02-05T05:57:34.000",
        "AENDR_TS": "2008-12-08T11:16:19.000",
        "Aendr_Funk": "KONVERTERING2009",
        "Ophoert_ts": null,
        "Gyldighedsdato": null,
        "GruMdlSplvnd": null,
        "GruPbFrbRens": null,
        "GruPbFrbRensDato": null,
        "GruTilUdtr": null,
        "GruTilUdtrDato": null,
        "GruTilAltAfld": null,
        "GruTilAltAfldDato": null
      }
    }
  }
  ,
  bygning: {
    '54a074d4-b006-442c-b7fb-092cb91b8693': {
      nestet: {
        "ois_id": 5344873,
        "ois_ts": "2016-12-12 19:23:12.463",
        "Bygning_id": "54a074d4-b006-442c-b7fb-092cb91b8693",
        "bygningsnr": null,
        "ObjStatus": 3,
        "NyByg": 0,
        "Crud_id": "996099990956509",
        "Grund_id": "db50f6b0-c332-45cf-8f7a-1161933e367a",
        "Byggesag_id": "12d459d3-1911-445b-b979-ce4a651eeb8f",
        "BygStam_id": "ac6fc70d-8e0c-4cb6-a573-75b6752bde8e",
        "AdgAdr_id": "0a3f507d-f236-32b8-e044-0003ba298018",
        "BYG_ANVEND_KODE": 930,
        "Klassifikation": 0,
        "AnvKonvKilde": 0,
        "AntLejMKoekken": 0,
        "AntLejUKoekken": 0,
        "OPFOERELSE_AAR": 0,
        "OMBYG_AAR": 0,
        "MIDL_OPRET_KODE": 0,
        "UdloebDatoMidl": null,
        "BYG_VANDFORSY_KODE": 0,
        "BYG_AFLOEB_KODE": null,
        "BYG_AFLOEB_TILL": null,
        "YDERVAEG_KODE": "5",
        "TAG_KODE": "2",
        "SuppYderVaegMat": null,
        "SuppTagDaekMat": null,
        "AsbestMateriale": null,
        "KILDE_MATR_KODE": "2",
        "BYG_ARL_SAML": 0,
        "BYG_BOLIG_ARL_SAML": 0,
        "ERHV_ARL_SAML": 0,
        "BYG_BEBYG_ARL": 35,
        "GARAGE_INDB_ARL": 0,
        "CARPORT_INDB_ARL": 0,
        "UDHUS_INDB_ARL": 0,
        "UDESTUE_ARL": 0,
        "LukOverdaekAreal": 0,
        "AFFALDSRUM_ARL": 0,
        "ANDET_ARL": 0,
        "OverdaekAreal": 0,
        "AabenOverdaekAreal": 0,
        "AdgangsAreal": 0,
        "Carport_Princip": null,
        "KILDE_ARL_KODE": 2,
        "ETAGER_ANT": 0,
        "ETAGER_AFVIG_KODE": 0,
        "VARMEINSTAL_KODE": null,
        "OPVARMNING_KODE": null,
        "VARME_SUPPL_KODE": null,
        "SIKRINGSRUM_ANT": 0,
        "FREDNING_KODE": null,
        "BevarVaerdig": null,
        "UdlejForhold1": null,
        "HusLeje": 0,
        "HuslejeOplysDato": null,
        "SagsType": "1",
        "BygPktNoejagtigKls": null,
        "BygPkt_id": "39c749bf-9ecd-4570-a52b-ae6810178563",
        "FOT_id": 0,
        "StormRaadPaalaeg": 0,
        "StormRaadPaalaegDato": null,
        "BygSkadeForsikSelskab": null,
        "BygSkadeForsikSelskabDato": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2016-12-12T09:29:06.463",
        "AENDR_TS": "2016-12-12T09:30:03.910",
        "Aendr_Funk": "BygningRet",
        "Ophoert_ts": null,
        "Kommune_id": "56d4cc87-195c-4486-bf3f-aa5142ba5279",
        "KomKode": "0185",
        "eRef": null,
        "Landsejerlavkode": 11659,
        "KomEjerlavKode": 5,
        "MatrNr": "2afÃ¸",
        "ESREjdNr": "051692",
        "Matr_art_kode": 0,
        "Delnr": null,
        "Opdelingsnr": null,
        "BygSkadeOmfatFors": null,
        "Gyldighedsdato": null,
        "href": "http://dawa/ois/bygninger/54a074d4-b006-442c-b7fb-092cb91b8693",
        "ejerskaber": [],
        "bygningspunkt": {
          "ois_id": 6093147,
          "ois_ts": "2016-12-12 19:26:53.370",
          "BygPkt_id": "39c749bf-9ecd-4570-a52b-ae6810178563",
          "href": "http://dawa/ois/bygningspunkter/39c749bf-9ecd-4570-a52b-ae6810178563",
          "Kommune_id": "56d4cc87-195c-4486-bf3f-aa5142ba5279",
          "PktRevDato": "2016-12-12T09:29:07.017",
          "KoorOest": 726016.09,
          "KoorNord": 6166521.3,
          "KoorSystem": 5,
          "TxtRetn": 200,
          "TxtPlacer": "5",
          "DDKNcelle100m": "100m_61665_7260",
          "DDKNcelle1km": "1km_6166_726",
          "DDKNcelle10km": "10km_616_72",
          "OPRET_TS": "2016-12-12T09:29:06.307",
          "AENDR_TS": "2016-12-12T09:29:06.307",
          "Aendr_Funk": "BygningOpret",
          "Ophoert_ts": null,
          "BygPktKilde": 0,
          "koordinater": [
            12.58708724,
            55.59208269
          ]
        }
      },
      flad: {
        "ois_id": 5344873,
        "ois_ts": "2016-12-12 19:23:12.463",
        "Bygning_id": "54a074d4-b006-442c-b7fb-092cb91b8693",
        "bygningsnr": null,
        "ObjStatus": 3,
        "NyByg": 0,
        "Crud_id": "996099990956509",
        "Grund_id": "db50f6b0-c332-45cf-8f7a-1161933e367a",
        "Byggesag_id": "12d459d3-1911-445b-b979-ce4a651eeb8f",
        "BygStam_id": "ac6fc70d-8e0c-4cb6-a573-75b6752bde8e",
        "AdgAdr_id": "0a3f507d-f236-32b8-e044-0003ba298018",
        "BYG_ANVEND_KODE": 930,
        "Klassifikation": 0,
        "AnvKonvKilde": 0,
        "AntLejMKoekken": 0,
        "AntLejUKoekken": 0,
        "OPFOERELSE_AAR": 0,
        "OMBYG_AAR": 0,
        "MIDL_OPRET_KODE": 0,
        "UdloebDatoMidl": null,
        "BYG_VANDFORSY_KODE": 0,
        "BYG_AFLOEB_KODE": null,
        "BYG_AFLOEB_TILL": null,
        "YDERVAEG_KODE": "5",
        "TAG_KODE": "2",
        "SuppYderVaegMat": null,
        "SuppTagDaekMat": null,
        "AsbestMateriale": null,
        "KILDE_MATR_KODE": "2",
        "BYG_ARL_SAML": 0,
        "BYG_BOLIG_ARL_SAML": 0,
        "ERHV_ARL_SAML": 0,
        "BYG_BEBYG_ARL": 35,
        "GARAGE_INDB_ARL": 0,
        "CARPORT_INDB_ARL": 0,
        "UDHUS_INDB_ARL": 0,
        "UDESTUE_ARL": 0,
        "LukOverdaekAreal": 0,
        "AFFALDSRUM_ARL": 0,
        "ANDET_ARL": 0,
        "OverdaekAreal": 0,
        "AabenOverdaekAreal": 0,
        "AdgangsAreal": 0,
        "Carport_Princip": null,
        "KILDE_ARL_KODE": 2,
        "ETAGER_ANT": 0,
        "ETAGER_AFVIG_KODE": 0,
        "VARMEINSTAL_KODE": null,
        "OPVARMNING_KODE": null,
        "VARME_SUPPL_KODE": null,
        "SIKRINGSRUM_ANT": 0,
        "FREDNING_KODE": null,
        "BevarVaerdig": null,
        "UdlejForhold1": null,
        "HusLeje": 0,
        "HuslejeOplysDato": null,
        "SagsType": "1",
        "BygPktNoejagtigKls": null,
        "BygPkt_id": "39c749bf-9ecd-4570-a52b-ae6810178563",
        "FOT_id": 0,
        "StormRaadPaalaeg": 0,
        "StormRaadPaalaegDato": null,
        "BygSkadeForsikSelskab": null,
        "BygSkadeForsikSelskabDato": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2016-12-12T09:29:06.463",
        "AENDR_TS": "2016-12-12T09:30:03.910",
        "Aendr_Funk": "BygningRet",
        "Ophoert_ts": null,
        "Kommune_id": "56d4cc87-195c-4486-bf3f-aa5142ba5279",
        "KomKode": "0185",
        "eRef": null,
        "Landsejerlavkode": 11659,
        "KomEjerlavKode": 5,
        "MatrNr": "2afÃ¸",
        "ESREjdNr": "051692",
        "Matr_art_kode": 0,
        "Delnr": null,
        "Opdelingsnr": null,
        "BygSkadeOmfatFors": null,
        "Gyldighedsdato": null,
        "bygningspunkt_ois_id": 6093147,
        "bygningspunkt_ois_ts": "2016-12-12 19:26:53.370",
        "bygningspunkt_BygPkt_id": "39c749bf-9ecd-4570-a52b-ae6810178563",
        "bygningspunkt_Kommune_id": "56d4cc87-195c-4486-bf3f-aa5142ba5279",
        "bygningspunkt_PktRevDato": "2016-12-12T09:29:07.017",
        "bygningspunkt_KoorOest": 726016.09,
        "bygningspunkt_KoorNord": 6166521.3,
        "bygningspunkt_KoorSystem": 5,
        "bygningspunkt_TxtRetn": 200,
        "bygningspunkt_TxtPlacer": "5",
        "bygningspunkt_DDKNcelle100m": "100m_61665_7260",
        "bygningspunkt_DDKNcelle1km": "1km_6166_726",
        "bygningspunkt_DDKNcelle10km": "10km_616_72",
        "bygningspunkt_OPRET_TS": "2016-12-12T09:29:06.307",
        "bygningspunkt_AENDR_TS": "2016-12-12T09:29:06.307",
        "bygningspunkt_Aendr_Funk": "BygningOpret",
        "bygningspunkt_Ophoert_ts": null,
        "bygningspunkt_BygPktKilde": 0,
        "bygningspunkt_koordinater_x": 12.58708724,
        "bygningspunkt_koordinater_y": 55.59208269
      },
      mini: {
        "ois_id": 5344873,
        "ois_ts": "2016-12-12 19:23:12.463",
        "Bygning_id": "54a074d4-b006-442c-b7fb-092cb91b8693",
        "bygningsnr": null,
        "ObjStatus": 3,
        "NyByg": 0,
        "Crud_id": "996099990956509",
        "Grund_id": "db50f6b0-c332-45cf-8f7a-1161933e367a",
        "Byggesag_id": "12d459d3-1911-445b-b979-ce4a651eeb8f",
        "BygStam_id": "ac6fc70d-8e0c-4cb6-a573-75b6752bde8e",
        "AdgAdr_id": "0a3f507d-f236-32b8-e044-0003ba298018",
        "BYG_ANVEND_KODE": 930,
        "Klassifikation": 0,
        "AnvKonvKilde": 0,
        "AntLejMKoekken": 0,
        "AntLejUKoekken": 0,
        "OPFOERELSE_AAR": 0,
        "OMBYG_AAR": 0,
        "MIDL_OPRET_KODE": 0,
        "UdloebDatoMidl": null,
        "BYG_VANDFORSY_KODE": 0,
        "BYG_AFLOEB_KODE": null,
        "BYG_AFLOEB_TILL": null,
        "YDERVAEG_KODE": "5",
        "TAG_KODE": "2",
        "SuppYderVaegMat": null,
        "SuppTagDaekMat": null,
        "AsbestMateriale": null,
        "KILDE_MATR_KODE": "2",
        "BYG_ARL_SAML": 0,
        "BYG_BOLIG_ARL_SAML": 0,
        "ERHV_ARL_SAML": 0,
        "BYG_BEBYG_ARL": 35,
        "GARAGE_INDB_ARL": 0,
        "CARPORT_INDB_ARL": 0,
        "UDHUS_INDB_ARL": 0,
        "UDESTUE_ARL": 0,
        "LukOverdaekAreal": 0,
        "AFFALDSRUM_ARL": 0,
        "ANDET_ARL": 0,
        "OverdaekAreal": 0,
        "AabenOverdaekAreal": 0,
        "AdgangsAreal": 0,
        "Carport_Princip": null,
        "KILDE_ARL_KODE": 2,
        "ETAGER_ANT": 0,
        "ETAGER_AFVIG_KODE": 0,
        "VARMEINSTAL_KODE": null,
        "OPVARMNING_KODE": null,
        "VARME_SUPPL_KODE": null,
        "SIKRINGSRUM_ANT": 0,
        "FREDNING_KODE": null,
        "BevarVaerdig": null,
        "UdlejForhold1": null,
        "HusLeje": 0,
        "HuslejeOplysDato": null,
        "SagsType": "1",
        "BygPktNoejagtigKls": null,
        "BygPkt_id": "39c749bf-9ecd-4570-a52b-ae6810178563",
        "FOT_id": 0,
        "StormRaadPaalaeg": 0,
        "StormRaadPaalaegDato": null,
        "BygSkadeForsikSelskab": null,
        "BygSkadeForsikSelskabDato": null,
        "KomFelt1": null,
        "KomFelt2": null,
        "KomFelt3": null,
        "KomFelt4": 0,
        "KomFelt5": 0,
        "KomFelt6": 0,
        "JourNr": null,
        "ESDH_Ref": null,
        "SikKlas": 0,
        "OPRET_TS": "2016-12-12T09:29:06.463",
        "AENDR_TS": "2016-12-12T09:30:03.910",
        "Aendr_Funk": "BygningRet",
        "Ophoert_ts": null,
        "Kommune_id": "56d4cc87-195c-4486-bf3f-aa5142ba5279",
        "KomKode": "0185",
        "eRef": null,
        "Landsejerlavkode": 11659,
        "KomEjerlavKode": 5,
        "MatrNr": "2afÃ¸",
        "ESREjdNr": "051692",
        "Matr_art_kode": 0,
        "Delnr": null,
        "Opdelingsnr": null,
        "BygSkadeOmfatFors": null,
        "Gyldighedsdato": null
      }
    }
  }
};

describe('OIS API', () => {
  testdb.withTransactionEach('test', (clientFn) => {
    for (let modelName of Object.keys(oisApiModels)) {
      const getByKeyResource = registry.findWhere({
        entityName: `ois_${modelName}_full`,
        type: 'resource',
        qualifier: 'getByKey'
      });
      if (expectedResults[modelName]) {
        const tests = expectedResults[modelName];
        for (let id of Object.keys(tests)) {
          const strukturParams = Object.keys(tests[id]);
          for (let strukturParam of strukturParams) {
            it(`Skal returnere korrekt svar for entity=${modelName}, struktur=${strukturParam}`,
              () => go(function*() {
                const expectedResult = tests[id][strukturParam];
                const result = yield helpers.getJson(clientFn(),
                  getByKeyResource,
                  {id: id},
                  {struktur: strukturParam});
                assert.deepEqual(expectedResult, result);
              }));
          }
        }
      }
    }
  });
});

